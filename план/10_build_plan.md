# План сборки единого HTML-файла

## Цель
Создать единый HTML-файл размером **≤ 5 МБ**, содержащий всю игру.

---

## Текущая ситуация

### Структура проекта
- **Модульная структура**: `game/src/` с отдельными JS файлами
- **Внешние зависимости**: CDN (GSAP, PixiJS, Howler.js)
- **Ассеты**: Отдельные файлы в `reference/reference_assets/`
- **Размер ассетов**: ~1.7 МБ (data URI)

### Референс
- **Размер референса**: 2.9 МБ
- **Структура**: Все встроено в один HTML
- **Ассеты**: Data URI в HTML

---

## План действий

### Этап 1: Подготовка инфраструктуры сборки ✅

**Задачи:**
- [x] Создать папку `build/` для скриптов сборки
- [ ] Создать скрипт `build/bundle.js` для объединения файлов
- [ ] Создать скрипт `build/optimize.js` для оптимизации
- [ ] Настроить package.json с командами сборки

**Результат**: Инфраструктура для сборки готова

---

### Этап 2: Конвертация ассетов в Data URI

**Задачи:**
- [ ] Создать скрипт для конвертации всех ассетов в base64
- [ ] Оптимизировать изображения (WebP, сжатие)
- [ ] Оптимизировать аудио (MP3, сжатие)
- [ ] Создать маппинг: путь файла → data URI

**Приоритет оптимизации:**
1. **Изображения** (самый большой размер):
   - Конвертировать PNG → WebP где возможно
   - Сжать существующие WebP
   - Уменьшить качество для больших изображений
   
2. **Аудио**:
   - Оптимизировать MP3 (битрейт, частота)
   - Удалить неиспользуемые аудио файлы
   
3. **Шрифты**:
   - Использовать только необходимые глифы
   - Сжать TTF

**Ожидаемый размер после оптимизации**: ~1.2-1.5 МБ

---

### Этап 3: Объединение JavaScript кода

**Задачи:**
- [ ] Собрать все JS модули в один файл
- [ ] Заменить импорты на встроенный код
- [ ] Встроить PixiJS (вместо CDN)
- [ ] Встроить Howler.js (вместо CDN)
- [ ] Оставить GSAP через CDN (или встроить если нужно)

**Стратегия:**
1. Использовать **ESBuild** или **Rollup** для бандлинга
2. Заменить `import` на встроенный код
3. Встроить библиотеки из `node_modules` или CDN

**Ожидаемый размер JS**: ~800 КБ - 1.2 МБ (минифицированный)

---

### Этап 4: Встраивание в HTML

**Задачи:**
- [ ] Создать шаблон HTML
- [ ] Встроить все CSS (inline или `<style>`)
- [ ] Встроить весь JavaScript (`<script>`)
- [ ] Заменить пути к ассетам на data URI
- [ ] Встроить шрифты (base64)

**Структура финального HTML:**
```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Runner Game</title>
  <style>
    /* Все CSS здесь */
    @font-face {
      font-family: 'GameFont';
      src: url('data:font/ttf;base64,...');
    }
  </style>
</head>
<body>
  <div id="preloader">...</div>
  <script>
    // Весь JavaScript здесь
    // Все пути к ассетам заменены на data URI
  </script>
</body>
</html>
```

---

### Этап 5: Минификация и оптимизация

**Задачи:**
- [ ] Минифицировать JavaScript (Terser/Uglify)
- [ ] Минифицировать CSS
- [ ] Минифицировать HTML
- [ ] Удалить комментарии
- [ ] Удалить неиспользуемый код (tree-shaking)

**Инструменты:**
- **JavaScript**: Terser или ESBuild minify
- **CSS**: cssnano
- **HTML**: html-minifier

**Ожидаемое уменьшение**: 30-40%

---

### Этап 6: Проверка размера и оптимизация

**Задачи:**
- [ ] Измерить размер финального файла
- [ ] Если > 5 МБ → дополнительная оптимизация:
  - Дальнейшее сжатие изображений
  - Удаление неиспользуемых ассетов
  - Оптимизация аудио
  - Удаление неиспользуемого кода

**Целевое распределение размера:**
- JavaScript: ~1.2 МБ
- Изображения: ~1.5 МБ
- Аудио: ~400 КБ
- Шрифты: ~50 КБ
- HTML/CSS: ~50 КБ
- **Итого**: ~3.2 МБ (запас для роста)

---

## Инструменты и технологии

### Для сборки
- **ESBuild** или **Rollup** - бандлинг JS
- **Node.js** - выполнение скриптов сборки
- **Sharp** или **imagemin** - оптимизация изображений
- **ffmpeg** или **lame** - оптимизация аудио

### Для минификации
- **Terser** - минификация JS
- **cssnano** - минификация CSS
- **html-minifier** - минификация HTML

---

## Команды сборки

### package.json scripts:
```json
{
  "scripts": {
    "build": "node build/bundle.js",
    "build:optimize": "node build/optimize.js",
    "build:all": "npm run build && npm run build:optimize",
    "build:check-size": "node build/check-size.js"
  }
}
```

---

## Контрольные точки

### После каждого этапа:
1. ✅ Проверить, что игра работает
2. ✅ Измерить размер промежуточного файла
3. ✅ Убедиться, что нет ошибок
4. ✅ Проверить производительность

### Финальная проверка:
- [ ] Размер файла ≤ 5 МБ
- [ ] Игра работает в браузере
- [ ] Все функции работают
- [ ] Нет ошибок в консоли
- [ ] Производительность приемлемая

---

## Риски и решения

### Риск 1: Размер превышает 5 МБ
**Решение**: 
- Дополнительная оптимизация изображений
- Удаление неиспользуемых ассетов
- Использование более агрессивного сжатия

### Риск 2: Производительность ухудшается
**Решение**:
- Ленивая загрузка ассетов где возможно
- Оптимизация рендеринга
- Кэширование

### Риск 3: Сложность отладки
**Решение**:
- Сохранять source maps для разработки
- Создавать dev и prod версии
- Логирование в dev режиме

---

## Следующие шаги

1. **Создать скрипт сборки** (`build/bundle.js`)
2. **Начать с простого**: объединить JS файлы
3. **Добавить конвертацию ассетов**
4. **Оптимизировать размер**
5. **Тестировать на каждом этапе**

---

## Примечания

- Референс весит 2.9 МБ, у нас есть запас до 5 МБ
- Можно использовать более агрессивное сжатие чем в референсе
- Важно сохранить качество игры при оптимизации
- Тестировать на разных браузерах после сборки
