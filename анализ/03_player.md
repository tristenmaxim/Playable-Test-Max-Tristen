# Player ($S) - Детальный анализ

## Обзор

`$S` (Player) - класс игрока, управляющий анимациями, физикой прыжков, состоянием и отрисовкой персонажа.

---

## Структура класса

### Конструктор
```javascript
constructor() {
  // Инициализация всех свойств через V() helper
}
```

### Основные свойства

#### Состояние
- `isOnGround` - флаг нахождения на земле
- `isInvincible` - флаг неуязвимости (после получения урона)
- `currentAnimation` - текущая анимация
- `animationState` - состояние анимации

#### Физика
- `x` - позиция по X
- `y` - позиция по Y (обычно `oe.GROUND_Y`)
- `velocityY` - вертикальная скорость (для прыжков)
- `gravity` - сила гравитации
- `jumpPower` - сила прыжка

#### Спрайты и анимации
- `sprite` - основной спрайт игрока
- `animations` - объект с анимациями (idle, run, jump, hurt)
- `zIndex` - порядок отрисовки (`me.PLAYER`)

---

## Методы

### Инициализация

#### `async init()`
Инициализирует игрока:
1. Загружает текстуры/спрайты
2. Создаёт основной спрайт
3. Настраивает начальную позицию (`x`, `y = oe.GROUND_Y`)
4. Создаёт анимации (idle, run, jump, hurt)
5. Устанавливает начальное состояние (idle)

### Анимации

#### `idle(dead = false)`
Переводит игрока в состояние покоя:
- Останавливает текущую анимацию
- Запускает анимацию idle
- Если `dead = true` → возможно анимация смерти

#### `run()`
Запускает анимацию бега:
- Останавливает текущую анимацию
- Запускает анимацию run (циклическая)

#### `jump()`
Выполняет прыжок:
- Проверяет `isOnGround`
- Устанавливает `velocityY = -jumpPower`
- Устанавливает `isOnGround = false`
- Запускает анимацию jump

#### `hurt()`
Обрабатывает получение урона:
- Запускает анимацию hurt
- Устанавливает `isInvincible = true`
- Через некоторое время снимает неуязвимость

### Обновление

#### `update(deltaMS)`
Обновляет состояние игрока каждый кадр:

1. **Физика прыжка:**
   - Если не на земле:
     - Применяет гравитацию: `velocityY += gravity`
     - Обновляет позицию: `y += velocityY * deltaMS / 1000`
     - Если `y >= oe.GROUND_Y`:
       - Устанавливает `y = oe.GROUND_Y`
       - Устанавливает `isOnGround = true`
       - Устанавливает `velocityY = 0`
       - Если была анимация jump → переключает на run

2. **Обновление анимаций:**
   - Обновляет текущую анимацию

3. **Неуязвимость:**
   - Уменьшает таймер неуязвимости
   - Если таймер <= 0 → снимает `isInvincible`

### Хитбокс

#### `getHitbox()`
Возвращает прямоугольник для коллизий:
```javascript
return {
  x: this.sprite.x - this.sprite.width / 2,
  y: this.sprite.y - this.sprite.height / 2,
  width: this.sprite.width,
  height: this.sprite.height
}
```

### Сброс

#### `reset()`
Сбрасывает игрока в начальное состояние:
- Позиция → начальная (`x`, `y = oe.GROUND_Y`)
- Состояние → idle
- Сбрасывает все флаги
- Останавливает анимации

---

## Физика прыжков

### Параметры
- `gravity` - ускорение свободного падения (положительное значение)
- `jumpPower` - начальная скорость прыжка (отрицательное значение)

### Механика
1. При вызове `jump()`:
   - `velocityY = -jumpPower` (игрок движется вверх)
   - `isOnGround = false`

2. В `update()`:
   - Каждый кадр: `velocityY += gravity` (увеличивается скорость падения)
   - Позиция обновляется: `y += velocityY * deltaMS / 1000`

3. Приземление:
   - Когда `y >= oe.GROUND_Y`:
     - Игрок останавливается на земле
     - `isOnGround = true`
     - `velocityY = 0`

---

## Анимации

### Типы анимаций
- **idle** - покой (циклическая)
- **run** - бег (циклическая)
- **jump** - прыжок (одноразовая, переключается на run при приземлении)
- **hurt** - получение урона (одноразовая, затем idle/run)

### Управление
- Анимации управляются через PixiJS AnimatedSprite
- Переключение происходит через методы `idle()`, `run()`, `jump()`, `hurt()`

---

## Зависимости

- PixiJS Sprite, AnimatedSprite, Container
- Система загрузки ассетов (`te.load()`)
- Константы: `oe.GROUND_Y`, `me.PLAYER`

---

## Примечания

- Игрок всегда находится на фиксированной Y координате (`oe.GROUND_Y`) при нахождении на земле
- Прыжок реализован через простую физику с гравитацией
- Неуязвимость после урона предотвращает множественные попадания
- Хитбокс рассчитывается относительно центра спрайта
